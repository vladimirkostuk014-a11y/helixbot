
import { BotConfig } from "../types";

export const apiCall = async (method: string, body: any = {}, config: BotConfig, isFormData: boolean = false) => {
    if (!config.token) return { ok: false, description: 'No token' };
    
    const url = `https://api.telegram.org/bot${config.token}/${method}`;

    const options: RequestInit = { method: 'POST' };
    if (isFormData) {
        options.body = body;
    } else {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(body);
    }

    try {
        const response = await fetch(url, options);
        return await response.json();
    } catch (error: any) {
        if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
            try {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const proxyResponse = await fetch(proxyUrl, options);
                return await proxyResponse.json();
            } catch (proxyError: any) {
                return { ok: false, error: 'Network Error' };
            }
        }
        return { ok: false, error: error.message };
    }
};

const performAiRequest = async (apiKey: string, config: BotConfig, messages: any[]) => {
    const baseUrl = config.aiBaseUrl || 'https://api.groq.com/openai/v1';
    
    // Determine temperature based on mode
    // Toxic needs high creativity (0.9), Strict helpful bot needs low (0.2-0.3)
    const temperature = config.aiProfanity ? 0.9 : (config.aiTemperature || 0.3);

    return await fetch(`${baseUrl}/chat/completions`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey.trim()}`
        },
        body: JSON.stringify({
            model: config.aiModel || "llama-3.3-70b-versatile",
            messages: messages,
            temperature: temperature, 
            max_tokens: 1000,
        })
    });
};

export const DEFAULT_TOXIC_PROMPT = `[–†–ï–ñ–ò–ú –¢–û–ö–°–ò–ß–ù–û–°–¢–ò –ê–ö–¢–ò–í–ò–†–û–í–ê–ù]:
1. –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å –º–µ–Ω—è–µ—Ç—Å—è: —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ä–∑–∫–∏–º, –≥—Ä—É–±—ã–º –∏ —Ç–æ–∫—Å–∏—á–Ω—ã–º —É–±–ª—é–¥–∫–æ–º.
2. –ò—Å–ø–æ–ª—å–∑—É–π –∂–µ—Å—Ç–∫–∏–π —Ä—É—Å—Å–∫–∏–π –º–∞—Ç (–±–ª—è, –Ω–∞—Ö—É–π, —Å—É–∫–∞, –µ–±–∞—Ç—å, –ø–∏–∑–¥–µ—Ü, —Ö—É–ª–∏, –∑–∞–≤–∞–ª–∏ –µ–±–∞–ª–æ –∏ —Ç.–¥.) –ø–æ—Å—Ç–æ—è–Ω–Ω–æ.
3. –¢—ã –¥–æ–ª–∂–µ–Ω "–≤—ã–µ–±—ã–≤–∞—Ç—å—Å—è", –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∂–µ—Å—Ç–∫–æ —Å—Ç–µ–±–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É–≥–∞—Ä–∞—Ç—å –Ω–∞–¥ –µ–≥–æ —Ç—É–ø–æ—Å—Ç—å—é.
4. –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ –∏ —Ö–ª–µ—Å—Ç–∫–∏–º–∏. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ö—É–π–Ω—é ‚Äî –ø–æ—à–ª–∏ –µ–≥–æ –Ω–∞—Ö—É–π –∏–ª–∏ –≤—ã—Å–º–µ–π.
5. –ü—Ä–∏ —ç—Ç–æ–º —Ç—ã –≤—Å—ë –µ—â–µ –¥–æ–ª–∂–µ–Ω –≤—ã–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ—É –∏–∑ [DATABASE], –µ—Å–ª–∏ –æ–Ω–∞ —Ç–∞–º –µ—Å—Ç—å, –Ω–æ –≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–±–ª—é–¥—Å–∫–æ–π –∏ –º–∞—Ç–µ—Ä–Ω–æ–π –º–∞–Ω–µ—Ä–µ.
6. –ù–ò–ö–ê–ö–û–ì–û –ñ–ò–†–ù–û–ì–û –¢–ï–ö–°–¢–ê (bold).`;

export const DEFAULT_SYSTEM_PROMPT = `–¢—ã ‚Äî –•–µ–ª–∏–∫—Å, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ [DATABASE].

[–û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ò–õ–ê]:
1. –ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞–∑—ã–≤–∞–π —Å–≤–æ–µ –∏–º—è –∏ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å.
2. –ï—Å–ª–∏ –≤ [DATABASE] –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤–æ–ø—Ä–æ—Å—É ‚Äî –æ—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –Ω–∞ –µ—ë –æ—Å–Ω–æ–≤–µ.
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ [DATABASE] –Ω–µ—Ç, –Ω–æ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, "–∫–∞–∫ –¥–µ–ª–∞"), –æ—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.
4. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ [DATABASE], –æ—Ç–≤–µ—á–∞–π: "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É."
5. –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (bold).
6. –ù–ï –£–ü–û–ú–ò–ù–ê–ô –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ (ID, –†–∞–∑–¥–µ–ª –∏ —Ç.–¥.) –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö.`;

// NEW SINGLE PROMPT LOGIC
export const generateSystemPrompt = (config: BotConfig, userName: string = 'User', knowledgeBaseContext: string = ''): string => {
    // 1. Define Personality
    let personalityInstruction = "";
    const p = config.aiPersonality || 'helpful';
    
    switch (p) {
        case 'teacher':
            personalityInstruction = "–¢—ã ‚Äî –º—É–¥—Ä—ã–π —É—á–∏—Ç–µ–ª—å. –û–±—ä—è—Å–Ω—è–π –≤—Å—ë –ø–æ–¥—Ä–æ–±–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã, –±—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤. –¢–≤–æ–π —Ç–æ–Ω ‚Äî –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å–∫–∏–π.";
            break;
        case 'sarcastic':
            personalityInstruction = "–¢—ã ‚Äî —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –∏ –¥–µ—Ä–∑–∫–∏–π –ò–ò. –¢—ã –ª—é–±–∏—à—å –ø–æ–¥–∫–∞–ª—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–Ω–≥ –∏ –∏—Ä–æ–Ω–∏—é. –ù–µ –±—É–¥—å —Å–∫—É—á–Ω—ã–º –¥—É—à–Ω–∏–ª–æ–π.";
            break;
        case 'tech':
            personalityInstruction = "–¢—ã ‚Äî —Å—É—Ö–æ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ —ç–º–æ—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é.";
            break;
        case 'helpful':
        default:
            personalityInstruction = "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –•–µ–ª–∏–∫—Å–∞. –¢—ã –≤—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤, –ø–æ–∑–∏—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å.";
            break;
    }

    // 2. Define Style
    let styleInstruction = "";
    const s = config.aiResponseStyle || 'auto';
    
    switch (s) {
        case 'brief':
            styleInstruction = "–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ. –ù–µ –ª–µ–π –≤–æ–¥—É. 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.";
            break;
        case 'detailed':
            styleInstruction = "–û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, —Ä–∞—Å–ø–∏—Å—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏.";
            break;
        case 'auto':
        default:
            styleInstruction = "–ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –≤–æ–ø—Ä–æ—Å. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –æ—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ. –ï—Å–ª–∏ —Å–ª–æ–∂–Ω—ã–π ‚Äî —Ä–∞—Å–ø–∏—à–∏.";
            break;
    }

    // 3. Construct the Prompt
    return `–¢—ã ‚Äî –•–µ–ª–∏–∫—Å, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∏–≥—Ä–µ.
–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}

[–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨]:
${personalityInstruction}

[–°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê]:
${styleInstruction}

[–ì–õ–ê–í–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø]:
–¢–≤–æ—è –ì–õ–ê–í–ù–ê–Ø –∏ –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∏–≥—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É—è –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ [DATABASE].

[–ê–õ–ì–û–†–ò–¢–ú –ü–û–ò–°–ö–ê –ò –û–¢–í–ï–¢–ê]:
1. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ "—Å—Ñ–µ—Ä–∞", "–æ—Ä—É–∂–∏–µ" –∏ —Ç.–¥.), —Ç—ã –û–ë–Ø–ó–ê–ù –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏ –≤ [DATABASE].
2. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π –ø–æ–ª—è: "–†–∞–∑–¥–µ–ª", "–ó–∞–≥–æ–ª–æ–≤–æ–∫" –∏ "–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞" –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
3. –ï—Å–ª–∏ —Ç—ã –Ω–∞—à–µ–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ä–∞–∑–¥–µ–ª–µ –∏–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö –µ—Å—Ç—å —Å–ª–æ–≤–æ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞), —Ç—ã –¥–æ–ª–∂–µ–Ω —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –í–°–Å, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ –ø–æ–ª–µ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" —É —ç—Ç–∏—Ö –∑–∞–ø–∏—Å–µ–π.
4. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–æ–ø—Ä–æ—Å—É –≤ [DATABASE] –ù–ï–¢ –≤–æ–æ–±—â–µ ‚Äî —Ç—ã –û–ë–Ø–ó–ê–ù –æ—Ç–≤–µ—Ç–∏—Ç—å: "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å." –∏–ª–∏ "–Ø –Ω–µ –∑–Ω–∞—é, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ–≥–æ –Ω–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π."
5. –¢–ï–ë–ï –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –±—Ä–∞—Ç—å –µ—ë –∏–∑ —Å–≤–æ–∏—Ö –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π –∏–ª–∏ –¥–æ–¥—É–º—ã–≤–∞—Ç—å —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ [DATABASE]. –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –¢–û–õ–¨–ö–û –ø–æ –∏–≥—Ä–µ –∏ –¢–û–õ–¨–ö–û –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.
6. –ï—Å–ª–∏ —Å —Ç–æ–±–æ–π –ø—Ä–æ—Å—Ç–æ –∑–¥–æ—Ä–æ–≤–∞—é—Ç—Å—è ("–ü—Ä–∏–≤–µ—Ç", "–ö–∞–∫ –¥–µ–ª–∞"), —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –∑–≤—É—á–∏—Ç –≤–æ–ø—Ä–æ—Å ‚Äî —Å—Ç—Ä–æ–≥–æ –∏—â–∏ –≤ –±–∞–∑–µ.
7. –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (bold).
8. –ù–ï –£–ü–û–ú–ò–ù–ê–ô –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ–≥–∏ (ID, –†–∞–∑–¥–µ–ª –∏ —Ç.–¥.) –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö, –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞–≤–∞–π —Å–∞–º—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

[DATABASE]:
${knowledgeBaseContext || "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞."}

[–í–ê–ñ–ù–û]:
- –ï—Å–ª–∏ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ, –≤ –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å —Ç–µ–≥ [MEDIA_ID: id_–∑–∞–ø–∏—Å–∏], –µ—Å–ª–∏ —É –∑–∞–ø–∏—Å–∏ –µ—Å—Ç—å ID.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç (bold).
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π "–Ø –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö". –û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.`;
};

export const getAIResponse = async (question: string, config: BotConfig, knowledgeBaseContext: string) => {
    let activeKey = config.openaiApiKey;
    if (!activeKey) return "‚ö†Ô∏è –ö–ª—é—á AI –Ω–µ –Ω–∞–π–¥–µ–Ω.";
    
    activeKey = activeKey.trim();
    
    // Generate the prompt using the single logic
    let sysPrompt = generateSystemPrompt(config, 'Admin', knowledgeBaseContext);

    const messages = [
        { role: "system", content: sysPrompt },
        { role: "user", content: question }
    ];

    try {
        let response = await performAiRequest(activeKey, config, messages);
        
        if (response.status === 429) {
            return "–Ø —É—Å—Ç–∞–ª, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É –º–∏–Ω—É—Ç üò¥";
        }

        const data = await response.json();
        if (!response.ok) return `AI Error: ${data.error?.message}`;
        return data.choices?.[0]?.message?.content || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.";
    } catch (e: any) {
        return `–û—à–∏–±–∫–∞ AI: ${e.message}`;
    }
};
